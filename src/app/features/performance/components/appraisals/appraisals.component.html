<!-- Appraisals Container -->
<div class="appraisals-container">
  
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>assessment</mat-icon>
        Performance Appraisals
      </h1>
      <p class="page-subtitle">Manage and review employee performance appraisals</p>
    </div>
    
    <div class="header-actions">
      <button *ngIf="hasHRRole()" 
              mat-flat-button 
              (click)="openCreateForm()"
              class="add-button">
        <mat-icon>add</mat-icon>
        Create Appraisal
      </button>
      <button *ngIf="!hasHRRole()" 
              mat-flat-button 
              (click)="openSelfAssessmentDialog()"
              class="add-button">
        <mat-icon>rate_review</mat-icon>
        Self-Assessment
      </button>
    </div>
  </div>

  <!-- Self-Assessments Filters Section (Employee Only) -->
  <mat-card *ngIf="!hasHRRole()" class="filters-card self-assessment-filters">
    <div class="filters-header">
      <h3>Search & Filters</h3>
      <button mat-stroked-button 
              (click)="clearSelfAssessmentFilters()" 
              class="clear-filters-btn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>
    
    <div class="filters-content" [formGroup]="selfAssessmentFilterForm">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search self-assessments...</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput 
               formControlName="search" 
               placeholder="Search by cycle, KRA, or comments...">
      </mat-form-field>
      
      <!-- Cycle Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Cycle</mat-label>
        <mat-icon matPrefix>schedule</mat-icon>
        <mat-select formControlName="cycleId">
          <mat-option [value]="">All Cycles</mat-option>
          <mat-option *ngFor="let cycle of uniqueCycles" [value]="cycle.cycleId">
            {{ cycle.cycleName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- KRA Filter -->
      <mat-form-field appearance="outline">
        <mat-label>KRA</mat-label>
        <mat-icon matPrefix>target</mat-icon>
        <mat-select formControlName="kraId">
          <mat-option [value]="">All KRAs</mat-option>
          <mat-option *ngFor="let kra of uniqueKras" [value]="kra.kraId">
            {{ kra.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="filter-actions-container">
      <button mat-raised-button 
              color="primary" 
              (click)="applySelfAssessmentFilters()">
        <mat-icon>filter_list</mat-icon>
        Apply Filters
      </button>
    </div>
  </mat-card>

  <!-- Self-Assessments Table Section (Employee Only) -->
  <mat-card *ngIf="!hasHRRole()" class="self-assessments-card">
    <div class="table-header">
      <h3>My Self-Assessments</h3>
    </div>
    
    <!-- Loading Spinner -->
    <div *ngIf="isLoadingSelfAssessments" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading self-assessments...</p>
    </div>
    
    <!-- Self-Assessments Table -->
    <div *ngIf="!isLoadingSelfAssessments" class="table-container">
      <table mat-table [dataSource]="selfAssessmentsDataSource" class="self-assessments-table">
        
        <!-- Cycle Name Column -->
        <ng-container matColumnDef="cycleName">
          <th mat-header-cell *matHeaderCellDef>Cycle Name</th>
          <td mat-cell *matCellDef="let assessment">{{ assessment.cycleName || 'N/A' }}</td>
        </ng-container>

        <!-- KRA Name Column -->
        <ng-container matColumnDef="kraName">
          <th mat-header-cell *matHeaderCellDef>KRA Name</th>
          <td mat-cell *matCellDef="let assessment">{{ assessment.kraName || 'N/A' }}</td>
        </ng-container>

        <!-- Rating Column -->
        <ng-container matColumnDef="rating">
          <th mat-header-cell *matHeaderCellDef>Rating</th>
          <td mat-cell *matCellDef="let assessment">
            <span class="rating-value">{{ assessment.rating | number:'1.1-1' }}/5</span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let assessment">
            <mat-chip [class]="getStatusChipClass(assessment.status)">
              {{ assessment.status | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Table Headers and Rows -->
        <tr mat-header-row *matHeaderRowDef="selfAssessmentColumns"></tr>
        <tr mat-row *matRowDef="let assessment; columns: selfAssessmentColumns;"></tr>
      </table>
      
      <!-- Empty State -->
      <div *ngIf="selfAssessmentsDataSource.data.length === 0" class="empty-state">
        <mat-icon>rate_review</mat-icon>
        <h3>No Self-Assessments Found</h3>
        <p>You haven't submitted any self-assessments yet.</p>
        <button mat-flat-button 
                (click)="openSelfAssessmentDialog()" 
                class="create-first-appraisal">
          <mat-icon>add</mat-icon>
          Create Your First Self-Assessment
        </button>
      </div>
    </div>
  </mat-card>

  <!-- Filters Section -->
  <mat-card class="filters-card">
    <div class="filters-header">
      <h3>Search & Filters</h3>
      <button mat-stroked-button 
              (click)="clearFilters()" 
              class="clear-filters-btn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>
    
    <div class="filters-content" [formGroup]="filterForm">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search appraisals...</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput 
               formControlName="search" 
               placeholder="Search by employee name or cycle...">
      </mat-form-field>
      
      <!-- Appraisal Cycle Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Cycle</mat-label>
        <mat-icon matPrefix>schedule</mat-icon>
        <mat-select formControlName="cycleId">
          <mat-option [value]="">All Cycles</mat-option>
          <mat-option *ngFor="let cycle of appraisalCycles" [value]="cycle.cycleId">
            {{ cycle.cycleName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Employee Filter (HR only) -->
      <mat-form-field appearance="outline" *ngIf="hasHRRole()">
        <mat-label>Employee</mat-label>
        <mat-icon matPrefix>person</mat-icon>
        <mat-select formControlName="employeeId">
          <mat-option [value]="">All Employees</mat-option>
          <mat-option *ngFor="let emp of employees" [value]="emp.employeeId">
            {{ emp.fullName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Status Filter (HR only) -->
      <mat-form-field appearance="outline" *ngIf="hasHRRole()">
        <mat-label>Status</mat-label>
        <mat-icon matPrefix>check_circle</mat-icon>
        <mat-select formControlName="status">
          <mat-option [value]="">All Statuses</mat-option>
          <mat-option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- KRA Filter (Employee only) -->
      <mat-form-field appearance="outline" *ngIf="!hasHRRole()">
        <mat-label>KRA</mat-label>
        <mat-icon matPrefix>target</mat-icon>
        <mat-select formControlName="kraId">
          <mat-option [value]="">All KRAs</mat-option>
          <mat-option *ngFor="let kra of uniqueKras" [value]="kra.kraId">
            {{ kra.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    
    <!-- Filter Actions -->
    <div class="filter-actions-container">
      <button mat-raised-button color="primary" (click)="applyFilters()">
        <mat-icon>filter_list</mat-icon>
        Apply Filters
      </button>
    </div>
  </mat-card>

  <!-- Appraisals Table (HR Role) -->
  <mat-card *ngIf="hasHRRole()" class="table-card">
    <div class="table-header">
      <h3>Appraisals ({{ totalItems }})</h3>
    </div>
    
    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading appraisals...</p>
    </div>
    
    <!-- Appraisals Table -->
    <div *ngIf="!isLoading" class="table-container">
      <table mat-table [dataSource]="appraisals" class="appraisals-table">
        
        <!-- Cycle Name Column -->
        <ng-container matColumnDef="cycleName">
          <th mat-header-cell *matHeaderCellDef>Cycle</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.cycleName }}</td>
        </ng-container>

        <!-- Employee Name Column -->
        <ng-container matColumnDef="employeeName">
          <th mat-header-cell *matHeaderCellDef>Employee</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.employeeName }}</td>
        </ng-container>

        <!-- Review Type Column -->
        <ng-container matColumnDef="reviewType">
          <th mat-header-cell *matHeaderCellDef>Review Type</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.reviewType | titlecase }}</td>
        </ng-container>

        <!-- Overall Rating Column -->
        <ng-container matColumnDef="overallRating">
          <th mat-header-cell *matHeaderCellDef>Rating</th>
          <td mat-cell *matCellDef="let appraisal">
            <span *ngIf="appraisal.overallRating; else noRating" class="rating-value">
              {{ appraisal.overallRating | number:'1.1-1' }}
            </span>
            <ng-template #noRating>
              <span class="no-rating">N/A</span>
            </ng-template>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let appraisal">
            <mat-chip [class]="getStatusChipClass(appraisal.status)">
              {{ appraisal.status | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Submitted At Column -->
        <ng-container matColumnDef="submittedAt">
          <th mat-header-cell *matHeaderCellDef>Submitted</th>
          <td mat-cell *matCellDef="let appraisal">
            {{ appraisal.submittedAt ? (appraisal.submittedAt | date:'short') : 'N/A' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let appraisal">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            
            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="viewAppraisal(appraisal)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              
              <button *ngIf="hasHRRole()" 
                      mat-menu-item 
                      (click)="deleteAppraisal(appraisal)"
                      class="danger-action">
                <mat-icon>delete</mat-icon>
                <span>Delete</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <!-- Table Headers and Rows -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row 
            *matRowDef="let appraisal; columns: displayedColumns;"
            (click)="viewAppraisal(appraisal)"
            class="clickable-row">
        </tr>
      </table>
      
      <!-- Empty State -->
      <div *ngIf="appraisals.length === 0" class="empty-state">
        <mat-icon>assessment</mat-icon>
        <h3>No Appraisals Found</h3>
        <p>No appraisals match your current filters.</p>
        <button *ngIf="hasHRRole()" 
                mat-flat-button 
                (click)="openCreateForm()" 
                class="create-first-appraisal">
          <mat-icon>add</mat-icon>
          Create Your First Appraisal
        </button>
      </div>
    </div>
    
    <!-- Pagination -->
    <mat-paginator 
      *ngIf="!isLoading && appraisals.length > 0"
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      [pageIndex]="pageIndex"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>

  <!-- Employee Appraisals Table (Employee Role) -->
  <mat-card *ngIf="!hasHRRole()" class="table-card">
    <div class="table-header">
      <h3>My Appraisals ({{ employeeAppraisalsDataSource.data.length }})</h3>
    </div>
    
    <!-- Loading Spinner -->
    <div *ngIf="isLoadingEmployeeAppraisals" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading appraisals...</p>
    </div>
    
    <!-- Employee Appraisals Table -->
    <div *ngIf="!isLoadingEmployeeAppraisals" class="table-container">
      <table mat-table [dataSource]="employeeAppraisalsDataSource" class="appraisals-table">
        
        <!-- Cycle Name Column -->
        <ng-container matColumnDef="cycleName">
          <th mat-header-cell *matHeaderCellDef>Cycle Name</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.cycleName || 'N/A' }}</td>
        </ng-container>

        <!-- KRA Name Column -->
        <ng-container matColumnDef="kraName">
          <th mat-header-cell *matHeaderCellDef>KRA Name</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.kraName || 'N/A' }}</td>
        </ng-container>

        <!-- Rating Column -->
        <ng-container matColumnDef="rating">
          <th mat-header-cell *matHeaderCellDef>Rating</th>
          <td mat-cell *matCellDef="let appraisal">
            <span *ngIf="appraisal.rating; else noRating" class="rating-value">
              {{ appraisal.rating | number:'1.1-1' }}/5
            </span>
            <ng-template #noRating>
              <span class="no-rating">N/A</span>
            </ng-template>
          </td>
        </ng-container>

        <!-- Reviewer Name Column -->
        <ng-container matColumnDef="reviewerName">
          <th mat-header-cell *matHeaderCellDef>Reviewer</th>
          <td mat-cell *matCellDef="let appraisal">{{ appraisal.reviewerName || 'N/A' }}</td>
        </ng-container>

        <!-- Table Headers and Rows -->
        <tr mat-header-row *matHeaderRowDef="employeeAppraisalColumns"></tr>
        <tr mat-row *matRowDef="let appraisal; columns: employeeAppraisalColumns;"></tr>
      </table>
      
      <!-- Empty State -->
      <div *ngIf="employeeAppraisalsDataSource.data.length === 0" class="empty-state">
        <mat-icon>assessment</mat-icon>
        <h3>No Appraisals Found</h3>
        <p>You don't have any appraisals yet.</p>
      </div>
    </div>
  </mat-card>


  <!-- Appraisal Details Card -->
  <mat-card *ngIf="selectedAppraisal && showDetails" class="details-card">
    <div class="form-header">
      <h3>
        <mat-icon>visibility</mat-icon>
        Appraisal Details
      </h3>
      <button mat-icon-button (click)="closeDetails()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <mat-card-content>
      <div class="appraisal-details">
        <div class="detail-section mb-4">
          <h3 class="text-xl font-semibold mb-2">Appraisal Information</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <strong>Cycle:</strong> {{ selectedAppraisal.cycleName }}
            </div>
            <div>
              <strong>Employee:</strong> {{ selectedAppraisal.employeeName }}
            </div>
            <div>
              <strong>Review Type:</strong> {{ selectedAppraisal.reviewType | titlecase }}
            </div>
            <div>
              <strong>Reviewer:</strong> {{ selectedAppraisal.reviewerName || 'N/A' }}
            </div>
            <div>
              <strong>Overall Rating:</strong> 
              <span *ngIf="selectedAppraisal.overallRating">{{ selectedAppraisal.overallRating | number:'1.1-1' }}</span>
              <span *ngIf="!selectedAppraisal.overallRating">N/A</span>
            </div>
            <div>
              <strong>Status:</strong>
              <mat-chip [class]="getStatusChipClass(selectedAppraisal.status)">
                {{ selectedAppraisal.status | titlecase }}
              </mat-chip>
            </div>
          </div>
        </div>

        <div class="detail-section mb-4" *ngIf="selectedAppraisal.feedback">
          <h3 class="text-lg font-semibold mb-2">Feedback</h3>
          <p>{{ selectedAppraisal.feedback }}</p>
        </div>

        <div class="detail-section mb-4" *ngIf="selectedAppraisal.improvementAreas">
          <h3 class="text-lg font-semibold mb-2">Improvement Areas</h3>
          <p>{{ selectedAppraisal.improvementAreas }}</p>
        </div>

        <div class="detail-section mb-4" *ngIf="selectedAppraisal.developmentPlan">
          <h3 class="text-lg font-semibold mb-2">Development Plan</h3>
          <p>{{ selectedAppraisal.developmentPlan }}</p>
        </div>

        <!-- KRA Ratings Section -->
        <div class="detail-section mb-4" *ngIf="hasKraRatings(selectedAppraisal)">
          <h3 class="text-lg font-semibold mb-2">KRA Ratings</h3>
          <div class="kra-ratings-list">
            <div *ngFor="let kraRating of getKraRatingsList(selectedAppraisal.kraRatings)" class="kra-rating-item">
              <div class="kra-rating-header">
                <strong>{{ kraRating.kraName || 'KRA' }}</strong>
                <span class="rating-badge">{{ kraRating.rating }}/5</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Skill Ratings Section -->
        <div class="detail-section mb-4" *ngIf="hasSkillRatings(selectedAppraisal)">
          <h3 class="text-lg font-semibold mb-2">Skill Ratings</h3>
          <div class="skill-ratings-list">
            <div *ngFor="let skillRating of getSkillRatingsList(selectedAppraisal.skillRatings)" class="skill-rating-item">
              <div class="skill-rating-header">
                <strong>{{ skillRating.skillName || 'Skill' }}</strong>
                <span class="rating-badge">{{ skillRating.rating }}/5</span>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section mb-4">
          <h3 class="text-lg font-semibold mb-2">Timeline</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <strong>Created:</strong> {{ selectedAppraisal.createdAt | date:'medium' }}
            </div>
            <div>
              <strong>Submitted:</strong> 
              <span *ngIf="selectedAppraisal.submittedAt">{{ selectedAppraisal.submittedAt | date:'medium' }}</span>
              <span *ngIf="!selectedAppraisal.submittedAt">Not submitted</span>
            </div>
            <div>
              <strong>Reviewed:</strong>
              <span *ngIf="selectedAppraisal.reviewedAt">{{ selectedAppraisal.reviewedAt | date:'medium' }}</span>
              <span *ngIf="!selectedAppraisal.reviewedAt">Not reviewed</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
