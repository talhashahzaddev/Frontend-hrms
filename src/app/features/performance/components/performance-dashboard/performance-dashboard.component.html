<div class="performance-dashboard-container">

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading performance data...</p>
  </div>

  <!-- Employee Dashboard (visible only to non-HR users) -->
  <div *ngIf="!hasHRRole() && !isLoading">

    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <mat-icon>star</mat-icon>
          My Performance
        </h1>
        <p class="page-subtitle">View your performance metrics, skills, and appraisal history</p>
      </div>
    </div>

    <!-- Performance Stats Grid -->
    <div class="stats-grid">
      <!-- My Performance Card -->
      <mat-card class="stat-card stat-card-primary" *ngIf="myPerformanceMetrics">
        <mat-card-content>
          <div class="stat-item">
            <div class="stat-icon-wrapper">
              <mat-icon class="stat-icon">trending_up</mat-icon>
            </div>
            <div class="stat-details">
              <div class="stat-label">Current Rating</div>
              <div class="stat-value">{{ myPerformanceMetrics.currentRating | number:'1.1-1' }}</div>
              <div class="stat-footer">
                <div class="rating-stars">
                  <mat-icon *ngFor="let star of starRatings" 
                            [class.filled]="star <= myPerformanceMetrics.currentRating">
                    {{ star <= myPerformanceMetrics.currentRating ? 'star' : 'star_border' }}
                  </mat-icon>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Overall Rating Card -->
      <mat-card class="stat-card stat-card-success">
        <mat-card-content>
          <div class="stat-item">
            <div class="stat-icon-wrapper">
              <mat-icon class="stat-icon">assessment</mat-icon>
            </div>
            <div class="stat-details">
              <div class="stat-label">Overall Rating</div>
              <div class="stat-value">{{ overallRating || 0 | number:'1.1-1' }}</div>
              <div class="stat-footer">
                <span class="stat-hint">Out of 5.0</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Skills Count Card -->
      <mat-card class="stat-card stat-card-info" *ngIf="myPerformanceMetrics">
        <mat-card-content>
          <div class="stat-item">
            <div class="stat-icon-wrapper">
              <mat-icon class="stat-icon">school</mat-icon>
            </div>
            <div class="stat-details">
              <div class="stat-label">My Skills</div>
              <div class="stat-value">{{ myPerformanceMetrics.skillsCount || mySkills.length }}</div>
              <div class="stat-footer">
                <span class="stat-hint">Assessed skills</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Last Appraisal Card -->
      <mat-card class="stat-card stat-card-warning" *ngIf="myPerformanceMetrics && myPerformanceMetrics.lastAppraisalDate">
        <mat-card-content>
          <div class="stat-item">
            <div class="stat-icon-wrapper">
              <mat-icon class="stat-icon">calendar_today</mat-icon>
            </div>
            <div class="stat-details">
              <div class="stat-label">Last Review</div>
              <div class="stat-value">{{ myPerformanceMetrics.lastAppraisalDate | date:'MMM dd' }}</div>
              <div class="stat-footer">
                <span class="stat-hint">{{ myPerformanceMetrics.lastAppraisalDate | date:'yyyy' }}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Main Content Section -->
    <div class="main-content-section">
      
      <!-- My Skills Card -->
      <mat-card class="content-card skills-card">
        <div class="card-header">
          <h3>
            <mat-icon>school</mat-icon>
            My Skills
          </h3>
        </div>
        <mat-card-content>
          <div class="skills-list" *ngIf="mySkills.length > 0">
            <div *ngFor="let skill of mySkills" class="skill-item">
              <div class="skill-info">
                <div class="skill-name">{{ skill.skillName }}</div>
                <div class="skill-level-badge" [ngClass]="'level-' + skill.proficiencyLevel">
                  Level {{ skill.proficiencyLevel }}/5
                </div>
              </div>
              <mat-progress-bar 
                mode="determinate" 
                [value]="(skill.proficiencyLevel / 5) * 100"
                class="skill-progress"
                [ngClass]="'progress-level-' + skill.proficiencyLevel">
              </mat-progress-bar>
            </div>
          </div>

          <div *ngIf="!mySkills.length" class="empty-state">
            <mat-icon>school</mat-icon>
            <h3>No Skills Assessed</h3>
            <p>No skills have been assessed yet.</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- My Appraisals Card -->
      <mat-card class="content-card appraisals-card">
        <div class="card-header">
          <h3>
            <mat-icon>assessment</mat-icon>
            My Appraisals
          </h3>
        </div>
        <mat-card-content>
          <!-- Filter Section -->
          <div class="filter-section">
            <mat-form-field appearance="outline" class="cycle-select-field">
              <mat-label>Select Appraisal Cycle</mat-label>
              <mat-icon matPrefix>schedule</mat-icon>
              <mat-select [value]="selectedCycleId" (selectionChange)="onCycleChange($event.value)">
                <mat-option [value]="null">All Cycles</mat-option>
                <mat-option *ngFor="let cycle of appraisalCycles" [value]="cycle.cycleId">
                  {{ cycle.cycleName }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Appraisals Table -->
          <div class="table-container" *ngIf="employeeAppraisals.length > 0">
            <table mat-table [dataSource]="appraisalsDataSource" class="appraisals-table">
              
              <ng-container matColumnDef="cycleName">
                <th mat-header-cell *matHeaderCellDef>Cycle</th>
                <td mat-cell *matCellDef="let appraisal">
                  <div class="cycle-info">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ appraisal.cycleName }}</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="reviewType">
                <th mat-header-cell *matHeaderCellDef>Review Type</th>
                <td mat-cell *matCellDef="let appraisal">
                  <mat-chip class="review-type-chip" [ngClass]="'review-' + appraisal.reviewType">
                    {{ appraisal.reviewType | titlecase }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="reviewerName">
                <th mat-header-cell *matHeaderCellDef>Reviewer</th>
                <td mat-cell *matCellDef="let appraisal">
                  <div class="reviewer-info">
                    <mat-icon>person</mat-icon>
                    <span>{{ appraisal.reviewerName || 'N/A' }}</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="overallRating">
                <th mat-header-cell *matHeaderCellDef>Rating</th>
                <td mat-cell *matCellDef="let appraisal">
                  <div class="rating-display">
                    <span class="rating-value">{{ appraisal.overallRating | number:'1.1-1' }}</span>
                    <div class="rating-stars">
                      <mat-icon *ngFor="let star of starRatings" 
                                [class.filled]="star <= appraisal.overallRating">
                        {{ star <= appraisal.overallRating ? 'star' : 'star_border' }}
                      </mat-icon>
                    </div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="feedback">
                <th mat-header-cell *matHeaderCellDef>Feedback</th>
                <td mat-cell *matCellDef="let appraisal">
                  <div class="feedback-text">{{ appraisal.feedback || 'No feedback available' }}</div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>

          <!-- Empty State -->
          <div *ngIf="!employeeAppraisals.length" class="empty-state">
            <mat-icon>assessment</mat-icon>
            <h3>No Appraisals Found</h3>
            <p>You don't have any performance appraisals yet.</p>
          </div>
        </mat-card-content>
      </mat-card>

    </div>

    <!-- Team Performance Tab (for Managers) -->
    <mat-card class="content-card team-performance-card" *ngIf="hasManagerRole()">
      <div class="card-header">
        <h3>
          <mat-icon>groups</mat-icon>
          Team Performance Overview
        </h3>
      </div>
      <mat-card-content>
        <div *ngIf="teamPerformanceSummary" class="team-performance-section">
          <div class="summary-stats-grid">
            <div class="summary-stat-card">
              <div class="summary-stat-icon">
                <mat-icon>star</mat-icon>
              </div>
              <div class="summary-stat-details">
                <div class="summary-stat-label">Average Rating</div>
                <div class="summary-stat-value">{{ teamPerformanceSummary.averageRating | number:'1.1-1' }}</div>
              </div>
            </div>
            <div class="summary-stat-card">
              <div class="summary-stat-icon">
                <mat-icon>assignment</mat-icon>
              </div>
              <div class="summary-stat-details">
                <div class="summary-stat-label">Total Appraisals</div>
                <div class="summary-stat-value">{{ teamPerformanceSummary.totalAppraisals }}</div>
              </div>
            </div>
            <div class="summary-stat-card">
              <div class="summary-stat-icon">
                <mat-icon>pending_actions</mat-icon>
              </div>
              <div class="summary-stat-details">
                <div class="summary-stat-label">Pending Reviews</div>
                <div class="summary-stat-value">{{ teamPerformanceSummary.pendingAppraisals }}</div>
              </div>
            </div>
          </div>

          <div class="top-performers-section" *ngIf="teamPerformanceSummary.topPerformers && teamPerformanceSummary.topPerformers.length > 0">
            <h4 class="section-subtitle">
              <mat-icon>emoji_events</mat-icon>
              Top Performers
            </h4>
            <div class="top-performers-list">
              <div *ngFor="let performer of teamPerformanceSummary.topPerformers; let i = index" 
                   class="performer-item">
                <div class="performer-rank">
                  <span class="rank-number" [ngClass]="'rank-' + (i + 1)">
                    <mat-icon *ngIf="i === 0" class="trophy-icon">emoji_events</mat-icon>
                    <span *ngIf="i !== 0">{{ i + 1 }}</span>
                  </span>
                </div>
                <div class="performer-info">
                  <div class="performer-name">{{ performer.employeeName }}</div>
                  <div class="performer-details">
                    <mat-icon>work</mat-icon>
                    <span>{{ performer.position }}</span>
                    <mat-icon>business</mat-icon>
                    <span>{{ performer.department }}</span>
                  </div>
                </div>
                <div class="performer-rating">
                  <div class="rating-value">{{ performer.rating | number:'1.1-1' }}</div>
                  <div class="rating-stars">
                    <mat-icon *ngFor="let star of starRatings" 
                              [class.filled]="star <= performer.rating">
                      {{ star <= performer.rating ? 'star' : 'star_border' }}
                    </mat-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!teamPerformanceSummary" class="empty-state">
          <mat-icon>groups</mat-icon>
          <h3>No Team Data</h3>
          <p>No team performance data available.</p>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- HR/Admin Dashboard (visible only to HR users) -->
  <div *ngIf="hasHRRole() && !isLoading">
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <mat-icon>dashboard</mat-icon>
          Performance Dashboard
        </h1>
        <p class="page-subtitle">Manage appraisal cycles and performance metrics</p>
      </div>
      
      <div class="header-actions">
        <button mat-flat-button 
                (click)="openCreateCycleDialog()"
                class="add-button">
          <mat-icon>add</mat-icon>
          New Cycle
        </button>
      </div>
    </div>

    <!-- Appraisal Cycles Card -->
    <mat-card class="content-card cycles-card">
      <div class="card-header">
        <h3>
          <mat-icon>event</mat-icon>
          Appraisal Cycles
        </h3>
      </div>
      <mat-card-content>
        <div class="table-container" *ngIf="appraisalCycles.length > 0">
          <table mat-table [dataSource]="cyclesDataSource" class="cycles-table">
            
            <ng-container matColumnDef="cycleName">
              <th mat-header-cell *matHeaderCellDef>Cycle Name</th>
              <td mat-cell *matCellDef="let cycle">
                <div class="cycle-name-info">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ cycle.cycleName }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let cycle">{{ cycle.description || 'N/A' }}</td>
            </ng-container>

            <ng-container matColumnDef="dates">
              <th mat-header-cell *matHeaderCellDef>Dates</th>
              <td mat-cell *matCellDef="let cycle">
                <div class="dates-info">
                  <mat-icon>calendar_today</mat-icon>
                  <span>{{ cycle.startDate | date:'shortDate' }} - {{ cycle.endDate | date:'shortDate' }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let cycle">
                <mat-chip [class]="'status-chip status-' + cycle.status?.toLowerCase()">
                  <mat-icon>{{ getStatusIcon(cycle.status) }}</mat-icon>
                  {{ cycle.status | titlecase }}
                </mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let cycle">
                <button mat-icon-button [matMenuTriggerFor]="cycleMenu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #cycleMenu="matMenu">
                  <button mat-menu-item (click)="editCycle(cycle)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit</span>
                  </button>
                  <button mat-menu-item (click)="deleteCycle(cycle)">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedCycleColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedCycleColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!appraisalCycles.length" class="empty-state">
          <mat-icon>event</mat-icon>
          <h3>No Appraisal Cycles</h3>
          <p>No appraisal cycles have been created yet.</p>
          <button mat-flat-button (click)="openCreateCycleDialog()" class="create-first-button">
            <mat-icon>add</mat-icon>
            Create First Cycle
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

</div>
