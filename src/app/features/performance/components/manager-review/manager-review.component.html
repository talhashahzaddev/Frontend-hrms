<div class="manager-review-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">
      <mat-icon>rate_review</mat-icon>
      Manager Review
    </h1>
    <div class="header-info" *ngIf="activeCycle">
      <mat-chip color="primary">{{ activeCycle.cycleName }}</mat-chip>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!isLoading && !activeCycle" class="no-cycle">
    <mat-icon>info</mat-icon>
    <h2>No Active Appraisal Cycle</h2>
    <p>There is no active appraisal cycle at the moment.</p>
  </div>

  <div *ngIf="!isLoading && activeCycle">
    <!-- Employee Selection -->
    <mat-card class="selection-card">
      <mat-card-header>
        <mat-card-title>Select Employee to Review</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Employee</mat-label>
          <mat-select formControlName="employeeId" (selectionChange)="onEmployeeSelect($event.value)">
            <mat-option *ngFor="let employee of employees" [value]="employee.employeeId">
              {{ employee.firstName }} {{ employee.lastName }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Review Form -->
    <mat-card class="review-card" *ngIf="selectedEmployee">
      <mat-card-header>
        <mat-card-title>Review: {{ selectedEmployee.firstName }} {{ selectedEmployee.lastName }}</mat-card-title>
        <mat-card-subtitle>Appraisal Cycle: {{ activeCycle.cycleName }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          
          <!-- Overall Rating -->
          <div class="section">
            <h3>Overall Rating</h3>
            <mat-form-field appearance="outline" class="rating-field">
              <mat-label>Manager Rating (1-5)</mat-label>
              <mat-slider 
                formControlName="overallRating"
                min="1" 
                max="5" 
                step="1"
                discrete
                [displayWith]="formatLabel">
                <input matSliderThumb formControlName="overallRating">
              </mat-slider>
              <span class="rating-value">{{ reviewForm.get('overallRating')?.value || 0 }}</span>
            </mat-form-field>
            <p class="calculated-rating">
              Calculated Overall Rating: <strong>{{ calculateOverallRating().toFixed(2) }}</strong>
              <small>(KRAs 60%, Skills 30%, Manager 10%)</small>
            </p>
          </div>

          <mat-divider></mat-divider>

          <!-- KRA Ratings -->
          <div class="section" *ngIf="kraRatings.length > 0">
            <h3>KRA Ratings</h3>
            <p class="section-description">Review and adjust employee's self-assessment ratings for KRAs</p>
            
            <div formArrayName="kraRatings">
              <mat-expansion-panel *ngFor="let kraGroup of kraRatings.controls; let i = index" [formGroupName]="i" class="rating-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    {{ getKraTitle(kraGroup.get('kraId')?.value) }}
                  </mat-panel-title>
                  <mat-panel-description>
                    Employee: {{ kraGroup.get('employeeRating')?.value }}/5
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <div class="rating-fields">
                  <mat-form-field appearance="outline" class="rating-field">
                    <mat-label>Your Rating (1-5)</mat-label>
                    <mat-slider 
                      formControlName="rating"
                      min="1" 
                      max="5" 
                      step="1"
                      discrete
                      [displayWith]="formatLabel">
                      <input matSliderThumb formControlName="rating">
                    </mat-slider>
                    <span class="rating-value">{{ kraGroup.get('rating')?.value || 0 }}</span>
                  </mat-form-field>
                  
                  <div class="employee-comment" *ngIf="kraGroup.get('comments')?.value">
                    <strong>Employee Comment:</strong>
                    <p>{{ kraGroup.get('comments')?.value }}</p>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </div>

          <mat-divider *ngIf="kraRatings.length > 0 && skillRatings.length > 0"></mat-divider>

          <!-- Skill Ratings -->
          <div class="section" *ngIf="skillRatings.length > 0">
            <h3>Skill Ratings</h3>
            <p class="section-description">Review and adjust employee's self-assessment ratings for Skills</p>
            
            <div formArrayName="skillRatings">
              <mat-expansion-panel *ngFor="let skillGroup of skillRatings.controls; let i = index" [formGroupName]="i" class="rating-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    {{ getSkillName(skillGroup.get('skillId')?.value) }}
                  </mat-panel-title>
                  <mat-panel-description>
                    Employee: {{ skillGroup.get('employeeRating')?.value }}/5
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <div class="rating-fields">
                  <mat-form-field appearance="outline" class="rating-field">
                    <mat-label>Your Rating (1-5)</mat-label>
                    <mat-slider 
                      formControlName="rating"
                      min="1" 
                      max="5" 
                      step="1"
                      discrete
                      [displayWith]="formatLabel">
                      <input matSliderThumb formControlName="rating">
                    </mat-slider>
                    <span class="rating-value">{{ skillGroup.get('rating')?.value || 0 }}</span>
                  </mat-form-field>
                  
                  <div class="employee-comment" *ngIf="skillGroup.get('comments')?.value">
                    <strong>Employee Comment:</strong>
                    <p>{{ skillGroup.get('comments')?.value }}</p>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Feedback Sections -->
          <div class="section">
            <h3>Feedback & Development</h3>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Feedback</mat-label>
              <textarea matInput formControlName="feedback" rows="4" placeholder="Provide overall feedback..."></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Improvement Areas</mat-label>
              <textarea matInput formControlName="improvementAreas" rows="3" placeholder="Areas for improvement..."></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Development Plan</mat-label>
              <textarea matInput formControlName="developmentPlan" rows="3" placeholder="Development plan and recommendations..."></textarea>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting || reviewForm.invalid">
              <mat-icon>send</mat-icon>
              {{ isSubmitting ? 'Submitting...' : 'Submit Review & Consolidate' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>

